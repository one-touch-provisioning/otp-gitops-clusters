{{- if .Values.storage.enabled -}}
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: install-odf
  namespace: default
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
spec:
  disabled: false
  remediationAction: enforce
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: openshift-storage-namespace
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Namespace
                metadata:
                  labels:
                    openshift.io/cluster-monitoring: "true"
                  name: openshift-storage
                spec: {}
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: odf-operator-group
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1
                kind: OperatorGroup
                metadata:
                  name: openshift-storage-operatorgroup
                  namespace: openshift-storage
                spec:
                  targetNamespaces:
                  - openshift-storage
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: odf-subscription
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: Subscription
                metadata:
                  name: ocs-operator
                  namespace: openshift-storage
                spec:
                  channel: "stable-4.8" # <-- Channel should be modified depending on the OCS version to be installed. Please ensure to maintain compatibility with OCP version
                  installPlanApproval: Automatic
                  name: ocs-operator
                  source: redhat-operators
                  sourceNamespace: openshift-marketplace
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: odf-subscription-installed
        spec:
          remediationAction: inform
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: operators.coreos.com/v1alpha1
                kind: ClusterServiceVersion
                metadata:
                  namespace: openshift-storage
                spec:
                  displayName: OpenShift Data Foundation
                status:
                  phase: Succeeded
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: odf-storage-cluster
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: ocs.openshift.io/v1
                kind: StorageCluster
                metadata: 
                  name: ocs-storagecluster
                  namespace: openshift-storage
                spec: 
                  manageNodes: false
                  monPVCTemplate: 
                    spec: 
                      accessModes: 
                        - ReadWriteOnce
                      resources: 
                        requests: 
                          storage: 10Gi
                      storageClassName: {{ .Values.storage.storageClassName }}
                      volumeMode: Filesystem
                  storageDeviceSets: 
                    - 
                      count: 1
                      dataPVCTemplate: 
                        spec: 
                          accessModes: 
                            - ReadWriteOnce
                          resources: 
                            requests: 
                              storage: {{ .Values.storage.storageClusterSize }}
                          storageClassName: {{ .Values.storage.storageClassName }}
                          volumeMode: Block
                      name: ocs-deviceset
                      placement: {}
                      portable: true
                      replica: 3
                      resources: {}
{{- end -}}